<?php

/**
 * @file
 * Contains wxt_core.module.
 */

use Drupal\Core\Database\Query\AlterableInterface;
use Drupal\wxt_core\UpdateManager;

/**
 * Implements hook_modules_installed().
 */
function wxt_core_modules_installed(array $modules) {
  // Don't do anything during config sync.
  if (\Drupal::isConfigSyncing()) {
    return;
  }

  // Record the semantic version of every module in config.
  $versions = \Drupal::configFactory()->getEditable(UpdateManager::CONFIG_NAME);

  /** @var \Drupal\wxt_core\UpdateManager $update_manager */
  $update_manager = \Drupal::service('wxt.update_manager');

  foreach ($modules as $module) {
    $versions->set($module, $update_manager->getVersion($module));
  }
  // Sort the list by key.
  $versions_sorted = $versions->getRawData();
  ksort($versions_sorted);
  $versions->setData($versions_sorted)->save();
}

/**
 * Toggles the state of a specified menu link.
 */
function wxt_core_menu_state_toggle($menu_id, $enabled = TRUE) {
  $menu_link_manager = \Drupal::service('plugin.manager.menu.link');
  $front_page_link = $menu_link_manager->getDefinition($menu_id);
  $front_page_link['enabled'] = $enabled ? 1 : 0;
  $menu_link_manager->updateDefinition($menu_id, $front_page_link);
  $cache = \Drupal::cache('menu');
  $cache->deleteAll();
}

/**
 * Implements hook_query_TAG_alter() for comment_filter tag.
 */
function wxt_core_query_comment_filter_alter(AlterableInterface $query) {
  // Change comment order to DESC for 'comment' field.
  if ($query->getMetaData('base_table') == 'comment') {
    /** @var \Drupal\Core\Database\Query\SelectInterface $query */
    $order_by = &$query->getOrderBy();
    $expression = &$query->getExpressions();

    // 'c.cid' is for flat comment lists.
    if (isset($order_by['c.cid']) && $order_by['c.cid'] == 'ASC NULLS FIRST') {
      // Reverse order.
      $order_by['c.cid'] = 'DESC';
    }

    // 'torder' is for threaded comment lists.
    if (isset($order_by['torder']) && $order_by['torder'] == 'ASC NULLS FIRST') {
      // Reverse order for parent comments.
      // And reverse order for children comments.
      // EXPLANATION of '.z':
      // The 'thread' field is string like '10.01.12f'.
      // Each part of it is generated by Number::intToAlphadecimal.
      // See core/lib/Drupal/Component/Utility/Number.php.
      // This function returns string followed by character.
      // This character is finite:
      // Maximum integer value on a 64-bit system is 9223372036854775807.
      // In higher code variable $num will be '1y2p0ij32e8e7'.
      // And variable $length will be 13. Expression ord('0') is 48.
      // Therefore first character can be 60 at maximum.
      // For reverse sorting we need to add first heavy charachter,
      // For parent comment thread string.
      // If use previous logic the character 'z' will be always heavest,
      // Than other available children thread string.
      // For each comment thread we add '.z' and sort by it.
      $expression['torder']['expression'] = 'SUBSTRING_INDEX(SUBSTRING(c.thread, 1, (LENGTH(c.thread) - 1)), \'.\', 1)';
      $order_by['torder'] = 'DESC NULLS FIRST';
      $query->addExpression('CONCAT(SUBSTRING(c.thread, 1, (LENGTH(c.thread) - 1)), \'.z\')', 'torderchild');
      $query->orderBy('torderchild', 'DESC');
    }
  }
}

/**
 * Implements hook_token_info().
 */
function wxt_core_token_info() {
  $info['tokens']['site']['url-abs'] = [
    'name' => t('Absolute URL'),
    'description' => t('Url of the site with no language prefix'),
  ];
  return $info;
}

/**
 * Implements hook_tokens().
 */
function wxt_core_tokens($type, $tokens, array $data = [], array $options = []) {
  $replacements = [];
  global $base_root;

  if ($type == 'site') {

    foreach ($tokens as $name => $original) {
      switch ($name) {
        case 'url-abs':
          $replacements[$original] = $base_root;
          break;
      }
    }
  }

  return $replacements;
}
